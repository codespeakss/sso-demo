<!DOCTYPE html>
<html>
<head>
    <title>App 首页</title>
    <meta name="sso-base" content="http://sso.bewantbe.com">
    <meta name="client-id" content="app01">
    <script>
        // 获取指定 cookie 的值
        function getCookie(name) {
            const value = "; " + document.cookie;
            const parts = value.split("; " + name + "=");
            if (parts.length === 2) return parts.pop().split(";").shift();
            return null;
        }

        // 获取 cookie 的时间戳（假设格式: "value|timestamp"）
        function getCookieTimestamp(name) {
            const cookieValue = getCookie(name);
            if (!cookieValue) return null;
            const parts = cookieValue.split('|');
            return parts.length === 2 ? parseInt(parts[1], 10) : null;
        }

        // 获取 URL 参数
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // 设置 cookie（带过期时间，默认 30 分钟）
        function setCookie(name, value, minutes = 30) {
            const expires = new Date(Date.now() + minutes * 60 * 1000).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/`;
        }

        // 生成随机 state（用于防 CSRF）
        function genState(len = 16) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let out = '';
            for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
            return out;
        }

        async function checkCookieAndRedirect() {
            const SSO_BASE = document.querySelector('meta[name="sso-base"]')?.content;
            const clientId = document.querySelector('meta[name="client-id"]')?.content;
            const currentNoQuery = window.location.origin + window.location.pathname;

            if (!SSO_BASE || !clientId) {
                console.error('缺少 <meta name="sso-base"> 或 <meta name="client-id"> 配置');
                return;
            }

            // 解析 hash 中的 access_token 和 state（隐式模式返回）
            const hash = window.location.hash && window.location.hash.startsWith('#') ? window.location.hash.substring(1) : '';
            const hashParams = new URLSearchParams(hash);
            const accessTokenFromHash = hashParams.get('access_token');
            const stateFromHash = hashParams.get('state');

            if (accessTokenFromHash) {
                const storedState = sessionStorage.getItem('oauth_state');
                if (storedState && stateFromHash && stateFromHash !== storedState) {
                    alert('state 不匹配');
                    return;
                }
                sessionStorage.setItem('access_token', accessTokenFromHash);
                // 清理 URL 上的 fragment
                history.replaceState(null, '', currentNoQuery);

                try {
                    const uiResp = await fetch(`${SSO_BASE}/userinfo`, {
                        headers: { 'Authorization': `Bearer ${accessTokenFromHash}` }
                    });
                    if (!uiResp.ok) throw new Error('userinfo 请求失败');
                    const ui = await uiResp.json();
                    showContent(ui);
                    return;
                } catch (e) {
                    console.error(e);
                }
            }

            // 如果已有 access_token，尝试直接拿用户信息
            const existing = sessionStorage.getItem('access_token');
            if (existing) {
                try {
                    const uiResp = await fetch(`${SSO_BASE}/userinfo`, { headers: { 'Authorization': `Bearer ${existing}` } });
                    if (uiResp.ok) {
                        const ui = await uiResp.json();
                        showContent(ui);
                        return;
                    }
                } catch (e) { /* ignore */ }
            }

            // 无 token，倒计时后跳转到授权页（隐式模式）
            let countdown = 5;
            const countdownElem = document.getElementById('countdown');
            countdownElem.textContent = countdown;
            const interval = setInterval(() => {
                countdown--;
                countdownElem.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                    const st = genState();
                    sessionStorage.setItem('oauth_state', st);
                    const authorizeURL = `${SSO_BASE}/authorize?response_type=token&client_id=${encodeURIComponent(clientId)}&redirect_uri=${encodeURIComponent(currentNoQuery)}&state=${encodeURIComponent(st)}`;
                    window.location.href = authorizeURL;
                }
            }, 1000);

            document.getElementById('redirectNotice').style.display = 'block';
        }

        function showContent(user) {
            const username = (user && user.username) ? user.username : '用户';
            const picture = (user && user.picture) ? user.picture : '';

            const contentDiv = document.getElementById('content');
            contentDiv.querySelector('h1').textContent = "欢迎 " + username;
            contentDiv.style.display = 'block';
            document.getElementById('redirectNotice').style.display = 'none';

            const usernameLabel = document.getElementById('usernameLabel');
            const avatarImg = document.getElementById('avatarImg');
            const userAvatar = document.getElementById('userAvatar');

            usernameLabel.textContent = username;
            if (picture) {
                avatarImg.src = picture;
            } else {
                const initial = (username && username[0] ? username[0] : 'U').toUpperCase();
                const bg = '#60a5fa';
                const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>`+
                            `<rect width='100%' height='100%' fill='${bg}'/>`+
                            `<text x='50%' y='54%' text-anchor='middle' font-size='34' fill='white' font-family='Arial' font-weight='700'>${initial}</text>`+
                            `</svg>`;
                avatarImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
            }
            userAvatar.style.display = 'flex';
        }

        window.onload = checkCookieAndRedirect;
    </script>
    <style>
        .top-right-avatar{position:fixed;top:12px;right:12px;display:none;align-items:center;gap:8px;background:rgba(255,255,255,0.9);padding:6px 8px;border-radius:9999px;border:1px solid #e5e7eb;box-shadow:0 1px 2px rgba(0,0,0,.08)}
        .top-right-avatar img{width:32px;height:32px;border-radius:9999px;border:1px solid #e5e7eb}
        .top-right-avatar .username{font-size:14px;color:#374151}
    </style>
</head>
<body>
    <div id="userAvatar" class="top-right-avatar">
        <span id="usernameLabel" class="username"></span>
        <img id="avatarImg" alt="avatar" src="" />
    </div>
    <!-- 页面内容，初始隐藏 -->
    <div id="content" style="display:none;">
        <h1>欢迎 %s</h1>
        <p>您已经通过 SSO 登录。</p>
    </div>

    <!-- 跳转提示，初始隐藏 -->
    <div id="redirectNotice" style="display:none;">
        <p>登录信息失效，页面将在 <span id="countdown"></span> 秒后跳转...</p>
    </div>
</body>
</html>
