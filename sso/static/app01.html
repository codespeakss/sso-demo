<!DOCTYPE html>
<html>
<head>
    <title>App 首页</title>
    <meta name="sso-base" content="http://sso.bewantbe.com">
    <meta name="client-id" content="app01">
    <script>
        // 获取指定 cookie 的值
        function getCookie(name) {
            const value = "; " + document.cookie;
            const parts = value.split("; " + name + "=");
            if (parts.length === 2) return parts.pop().split(";").shift();
            return null;
        }

        // 获取 cookie 的时间戳（假设格式: "value|timestamp"）
        function getCookieTimestamp(name) {
            const cookieValue = getCookie(name);
            if (!cookieValue) return null;
            const parts = cookieValue.split('|');
            return parts.length === 2 ? parseInt(parts[1], 10) : null;
        }

        // 获取 URL 参数
        function getQueryParam(name) {
            const params = new URLSearchParams(window.location.search);
            return params.get(name);
        }

        // 设置 cookie（带过期时间，默认 30 分钟）
        function setCookie(name, value, minutes = 30) {
            const expires = new Date(Date.now() + minutes * 60 * 1000).toUTCString();
            document.cookie = `${name}=${value}; expires=${expires}; path=/`;
        }

        // 生成随机 state（用于防 CSRF）
        function genState(len = 16) {
            const chars = 'abcdefghijklmnopqrstuvwxyzABCDEFGHIJKLMNOPQRSTUVWXYZ0123456789';
            let out = '';
            for (let i = 0; i < len; i++) out += chars[Math.floor(Math.random() * chars.length)];
            return out;
        }

        async function checkCookieAndRedirect() {
            const SSO_BASE = document.querySelector('meta[name="sso-base"]')?.content;
            const clientId = document.querySelector('meta[name="client-id"]')?.content;
            const currentNoQuery = window.location.origin + window.location.pathname;

            if (!SSO_BASE || !clientId) {
                console.error('缺少 <meta name="sso-base"> 或 <meta name="client-id"> 配置');
                return;
            }

            // 读取后端配置，决定使用 implicit 还是 code
            let mode = 'implicit';
            try {
                const cfg = await fetch(`${SSO_BASE}/config`, { credentials: 'include' }).then(r => r.json());
                if (cfg && (cfg.mode === 'implicit' || cfg.mode === 'code')) {
                    mode = cfg.mode;
                }
            } catch (_) { /* default implicit */ }

            const params = new URLSearchParams(window.location.search);

            // 授权码模式：解析 code 并置换 token
            if (mode === 'code') {
                const code = params.get('code');
                const stateFromQuery = params.get('state');
                if (code) {
                    const storedState = sessionStorage.getItem('oauth_state');
                    if (storedState && stateFromQuery && stateFromQuery !== storedState) {
                        alert('state 不匹配');
                        return;
                    }
                    try {
                        const tokenResp = await fetch(`${SSO_BASE}/token`, {
                            method: 'POST',
                            headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                            body: new URLSearchParams({ grant_type: 'authorization_code', code })
                        });
                        if (!tokenResp.ok) throw new Error('token 交换失败');
                        const tk = await tokenResp.json();
                        const at = tk && tk.access_token;
                        if (!at) throw new Error('无 access_token');
                        sessionStorage.setItem('access_token', at);
                        // 清理 URL 上的查询参数
                        history.replaceState(null, '', currentNoQuery);
                        const uiResp = await fetch(`${SSO_BASE}/userinfo`, { headers: { 'Authorization': `Bearer ${at}` } });
                        if (!uiResp.ok) throw new Error('userinfo 请求失败');
                        const ui = await uiResp.json();
                        showContent(ui);
                        return;
                    } catch (e) {
                        console.error(e);
                    }
                }
            }

            // 隐式模式：解析 hash 中的 access_token 和 state
            const hash = window.location.hash && window.location.hash.startsWith('#') ? window.location.hash.substring(1) : '';
            const hashParams = new URLSearchParams(hash);
            const accessTokenFromHash = hashParams.get('access_token');
            const stateFromHash = hashParams.get('state');

            if (accessTokenFromHash) {
                const storedState = sessionStorage.getItem('oauth_state');
                if (storedState && stateFromHash && stateFromHash !== storedState) {
                    alert('state 不匹配');
                    return;
                }
                sessionStorage.setItem('access_token', accessTokenFromHash);
                history.replaceState(null, '', currentNoQuery);
                try {
                    const uiResp = await fetch(`${SSO_BASE}/userinfo`, {
                        headers: { 'Authorization': `Bearer ${accessTokenFromHash}` }
                    });
                    if (!uiResp.ok) throw new Error('userinfo 请求失败');
                    const ui = await uiResp.json();
                    showContent(ui);
                    return;
                } catch (e) {
                    console.error(e);
                }
            }

            // 如果已有 access_token，尝试直接拿用户信息
            const existing = sessionStorage.getItem('access_token');
            if (existing) {
                try {
                    const uiResp = await fetch(`${SSO_BASE}/userinfo`, { headers: { 'Authorization': `Bearer ${existing}` } });
                    if (uiResp.ok) {
                        const ui = await uiResp.json();
                        showContent(ui);
                        return;
                    }
                } catch (e) { /* ignore */ }
            }

            // 无 token，倒计时后跳转到授权页（按配置选择 response_type）
            let countdown = 5;
            const countdownElem = document.getElementById('countdown');
            countdownElem.textContent = countdown;
            const interval = setInterval(() => {
                countdown--;
                countdownElem.textContent = countdown;
                if (countdown <= 0) {
                    clearInterval(interval);
                    const st = genState();
                    sessionStorage.setItem('oauth_state', st);
                    const respType = mode === 'code' ? 'code' : 'token';
                    const authorizeURL = `${SSO_BASE}/authorize?response_type=${respType}&client_id=${encodeURIComponent(clientId)}&redirect_uri=${encodeURIComponent(currentNoQuery)}&state=${encodeURIComponent(st)}`;
                    window.location.href = authorizeURL;
                }
            }, 1000);

            document.getElementById('redirectNotice').style.display = 'block';
        }

        function showContent(user) {
            const username = (user && user.username) ? user.username : '用户';
            const picture = (user && user.picture) ? user.picture : '';

            const contentDiv = document.getElementById('content');
            contentDiv.querySelector('h1').textContent = "欢迎 " + username;
            contentDiv.style.display = 'block';
            document.getElementById('redirectNotice').style.display = 'none';

            const usernameLabel = document.getElementById('usernameLabel');
            const avatarImg = document.getElementById('avatarImg');
            const userAvatar = document.getElementById('userAvatar');

            usernameLabel.textContent = username;
            if (picture) {
                avatarImg.src = picture;
            } else {
                const initial = (username && username[0] ? username[0] : 'U').toUpperCase();
                const bg = '#60a5fa';
                const svg = `<svg xmlns='http://www.w3.org/2000/svg' width='64' height='64'>`+
                            `<rect width='100%' height='100%' fill='${bg}'/>`+
                            `<text x='50%' y='54%' text-anchor='middle' font-size='34' fill='white' font-family='Arial' font-weight='700'>${initial}</text>`+
                            `</svg>`;
                avatarImg.src = 'data:image/svg+xml;utf8,' + encodeURIComponent(svg);
            }
            userAvatar.style.display = 'flex';
        }

        window.addEventListener('load', function(){
            const ua = document.getElementById('userAvatar');
            const menu = document.getElementById('avatarMenu');
            const logoutLink = document.getElementById('logoutAction');
            if (ua && menu) {
                ua.addEventListener('click', function(e){
                    const isOpen = menu.style.display === 'flex' || menu.style.display === 'block';
                    menu.style.display = isOpen ? 'none' : 'flex';
                    e.stopPropagation();
                });
                document.addEventListener('click', function(){
                    if (menu) menu.style.display = 'none';
                });
            }
            if (logoutLink) {
                logoutLink.addEventListener('click', function(e){
                    e.preventDefault();
                    logout();
                });
            }
            checkCookieAndRedirect();
        });

        function logout() {
            try { sessionStorage.removeItem('access_token'); } catch (e) {}
            const SSO_BASE = document.querySelector('meta[name="sso-base"]')?.content;
            const currentNoQuery = window.location.origin + window.location.pathname;
            if (SSO_BASE) {
                window.location.href = `${SSO_BASE}/logout?redirect=${encodeURIComponent(currentNoQuery)}`;
            } else {
                window.location.reload();
            }
        }
    </script>
    <style>
        .top-right-avatar{position:fixed;top:12px;right:12px;display:none;align-items:center;gap:8px;background:rgba(255,255,255,0.9);padding:6px 8px;border-radius:9999px;border:1px solid #e5e7eb;box-shadow:0 1px 2px rgba(0,0,0,.08);cursor:pointer}
        .top-right-avatar img{width:32px;height:32px;border-radius:9999px;border:1px solid #e5e7eb}
        .top-right-avatar .username{font-size:14px;color:#374151}
        .avatar-wrapper{position:relative;display:flex;align-items:center;gap:8px}
        .avatar-menu{position:absolute;top:44px;right:0;background:#fff;border:1px solid #e5e7eb;border-radius:8px;box-shadow:0 8px 24px rgba(0,0,0,.12);min-width:140px;display:none;flex-direction:column;overflow:hidden;z-index:50}
        .avatar-menu a{padding:10px 12px;text-decoration:none;color:#111827;font-size:14px;display:block}
        .avatar-menu a:hover{background:#f3f4f6}
    </style>
</head>
<body>
    <div id="userAvatar" class="top-right-avatar">
        <div class="avatar-wrapper">
            <span id="usernameLabel" class="username"></span>
            <img id="avatarImg" alt="avatar" src="" />
            <div id="avatarMenu" class="avatar-menu">
                <a href="javascript:void(0)" id="logoutAction">退出登录</a>
            </div>
        </div>
    </div>
    <!-- 页面内容，初始隐藏 -->
    <div id="content" style="display:none;">
        <h1>欢迎 %s</h1>
        <p>您已经通过 SSO 登录。</p>
    </div>

    <!-- 跳转提示，初始隐藏 -->
    <div id="redirectNotice" style="display:none;">
        <p>登录信息失效，页面将在 <span id="countdown"></span> 秒后跳转...</p>
    </div>
</body>
</html>
